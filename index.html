<!DOCTYPE html>
<html lang="zh">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="moonrailgun" />
<meta name="description" content="一个兴趣使然的软件攻城狮的个人博客。兴趣是最好的老师。"/>
<script async defer data-website-id="be33e45e-5666-46a7-8080-e9e2be720b72" src="https://umami.moonrailgun.com/script.js"></script>
<script async defer src="https://tianji.moonrailgun.com/tracker.js" data-website-id="clp2l64d2435nmm5dcfc6hcoz"></script>


    
    


<meta property="og:type" content="website">
<meta property="og:title" content="moonrailgun - 兴趣使然的工程师 — 个人技术展示">
<meta property="og:url" content="http://www.moonrailgun.com/index.html">
<meta property="og:site_name" content="moonrailgun - 兴趣使然的工程师 — 个人技术展示">
<meta property="og:locale">
<meta property="article:author" content="moonrailgun">
<meta name="twitter:card" content="summary">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="moonrailgun - 兴趣使然的工程师 — 个人技术展示" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">





    <link href="https://lib.baomitu.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="https://lib.baomitu.com/pace/1.0.2/pace.min.js"></script>
    <link href="https://lib.baomitu.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">



<link rel="stylesheet" href="/css/style.css">




<link href="https://lib.baomitu.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>moonrailgun - 兴趣使然的工程师 — 个人技术展示</title>

<script src="https://lib.baomitu.com/jquery/2.2.4/jquery.min.js"></script>
<script src="https://lib.baomitu.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "https://lib.baomitu.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "https://lib.baomitu.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






<!-- plausible.io -->
<script defer data-domain="moonrailgun.com" src="https://plausible.io/js/script.file-downloads.hash.outbound-links.pageview-props.revenue.tagged-events.js"></script>
<script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/"></a></h1>
        </hgroup>

        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/show/">作品展示</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:moonrailgun@gmail.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" rel="noopener" href="https://github.com/moonrailgun" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Apache/" rel="tag">Apache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Apicloud/" rel="tag">Apicloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Blender/" rel="tag">Blender</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CCLog/" rel="tag">CCLog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CORS/" rel="tag">CORS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSLoader/" rel="tag">CSLoader</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/" rel="tag">ES6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GMT/" rel="tag">GMT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Garfish/" rel="tag">Garfish</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Github/" rel="tag">Github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Github-Action/" rel="tag">Github Action</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/" rel="tag">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML5/" rel="tag">HTML5</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTPS/" rel="tag">HTTPS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LINK1104/" rel="tag">LINK1104</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MMD/" rel="tag">MMD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MikuMikuCombat/" rel="tag">MikuMikuCombat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NSURL/" rel="tag">NSURL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NodeJS/" rel="tag">NodeJS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OOM-Killer/" rel="tag">OOM Killer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React-Query/" rel="tag">React Query</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ReactNative/" rel="tag">ReactNative</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ref/" rel="tag">Ref</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL/" rel="tag">SQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSL/" rel="tag">SSL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Session/" rel="tag">Session</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shader/" rel="tag">Shader</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Snowpack/" rel="tag">Snowpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Steam/" rel="tag">Steam</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swap/" rel="tag">Swap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TRPG/" rel="tag">TRPG</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TRPG-Engine/" rel="tag">TRPG Engine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tailchat/" rel="tag">Tailchat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TexturePacker/" rel="tag">TexturePacker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ubuntu-18-04/" rel="tag">Ubuntu 18.04</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unicode/" rel="tag">Unicode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity/" rel="tag">Unity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unreal/" rel="tag">Unreal</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/" rel="tag">Vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Webpack/" rel="tag">Webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Weex/" rel="tag">Weex</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WhiteWord/" rel="tag">WhiteWord</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/adb/" rel="tag">adb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/atom/" rel="tag">atom</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/auth/" rel="tag">auth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/autorelease/" rel="tag">autorelease</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blender/" rel="tag">blender</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/callback/" rel="tag">callback</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/centos7/" rel="tag">centos7</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cherry-pick/" rel="tag">cherry-pick</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chrome/" rel="tag">chrome</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chromium/" rel="tag">chromium</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cluster/" rel="tag">cluster</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cocoapods/" rel="tag">cocoapods</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cocos2dx/" rel="tag">cocos2dx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/commonjs/" rel="tag">commonjs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cookie/" rel="tag">cookie</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/" rel="tag">css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cycle/" rel="tag">cycle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debounce/" rel="tag">debounce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/devops/" rel="tag">devops</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docusaurus/" rel="tag">docusaurus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docusaurus-v2/" rel="tag">docusaurus v2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/esmodule/" rel="tag">esmodule</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/extensions/" rel="tag">extensions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/firefox/" rel="tag">firefox</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gcc/" rel="tag">gcc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gradient/" rel="tag">gradient</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gulp/" rel="tag">gulp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hao360/" rel="tag">hao360</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http/" rel="tag">http</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/https/" rel="tag">https</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS/" rel="tag">iOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ionic/" rel="tag">ionic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ios/" rel="tag">ios</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/" rel="tag">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k3s/" rel="tag">k3s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="tag">lambda表达式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/libcocos2d-2013-lib/" rel="tag">libcocos2d_2013.lib</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lodash/" rel="tag">lodash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/meta-program/" rel="tag">meta program</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mini-star/" rel="tag">mini-star</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/" rel="tag">node</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node-orm/" rel="tag">node-orm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nox/" rel="tag">nox</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/npm/" rel="tag">npm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/objective-c/" rel="tag">objective-c</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ohmyzsh/" rel="tag">ohmyzsh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pod/" rel="tag">pod</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pomelo/" rel="tag">pomelo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pubg/" rel="tag">pubg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react-virtualized/" rel="tag">react-virtualized</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/requirejs/" rel="tag">requirejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rfc/" rel="tag">rfc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/safari/" rel="tag">safari</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sequelizejs/" rel="tag">sequelizejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/session/" rel="tag">session</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssl/" rel="tag">ssl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stacking-context/" rel="tag">stacking context</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sticky/" rel="tag">sticky</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/svg/" rel="tag">svg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swarm/" rel="tag">swarm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swift/" rel="tag">swift</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tailwindcss/" rel="tag">tailwindcss</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/throttle/" rel="tag">throttle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/traefik/" rel="tag">traefik</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/typescript/" rel="tag">typescript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unity/" rel="tag">unity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/upyun/" rel="tag">upyun</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/utf-8/" rel="tag">utf-8</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vercel/" rel="tag">vercel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/" rel="tag">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vmware/" rel="tag">vmware</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/" rel="tag">webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack-dev-server/" rel="tag">webpack-dev-server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack-stats-viewer/" rel="tag">webpack-stats-viewer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/weixin/" rel="tag">weixin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wsl/" rel="tag">wsl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wsl2/" rel="tag">wsl2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/z-index/" rel="tag">z-index</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zustand/" rel="tag">zustand</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%A7%E7%A0%94%E6%95%88%E8%83%BD/" rel="tag">产研效能</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E4%BB%93%E5%BA%93/" rel="tag">代码仓库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96/" rel="tag">代码优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%90%8E%E5%8F%B0/" rel="tag">后台</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A3%81%E7%BA%B8/" rel="tag">壁纸</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%97%E8%8A%82%E8%B7%B3%E5%8A%A8/" rel="tag">字节跳动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%88%E6%9C%9B%E5%85%88%E9%94%8B/" rel="tag">守望先锋</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%89%E5%85%A8/" rel="tag">安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E7%A8%8B%E5%8C%96/" rel="tag">工程化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B8%B8%E7%94%A8%E6%8A%80%E5%B7%A7/" rel="tag">常用技巧</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/" rel="tag">开发笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%AE%E4%BF%A1/" rel="tag">微信</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%AE%E5%86%85%E6%A0%B8/" rel="tag">微内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%AE%E5%89%8D%E7%AB%AF/" rel="tag">微前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BF%AB%E6%8D%B7%E6%96%B9%E5%BC%8F/" rel="tag">快捷方式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" rel="tag">性能优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8/" rel="tag">持久化存储</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%91%87%E6%A0%91%E4%BC%98%E5%8C%96/" rel="tag">摇树优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%87%E6%A1%A3/" rel="tag">文档</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%B6%E9%97%B4%E6%A0%BC%E5%BC%8F/" rel="tag">时间格式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag">服务器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98/" rel="tag">每日一题</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B3%A8%E5%86%8C%E8%A1%A8/" rel="tag">注册表</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%B2%E6%9F%93/" rel="tag">渲染</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/" rel="tag">游戏开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E5%AE%9A%E4%BD%8D/" rel="tag">源码定位</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="tag">源码解析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%88%B6%E5%AD%90%E5%85%B3%E7%B3%BB/" rel="tag">父子关系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%89%88%E6%9C%AC%E5%8F%B7/" rel="tag">版本号</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/" rel="tag">状态管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%AB%99%E5%8A%AB%E6%8C%81/" rel="tag">网站劫持</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag">网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%83%A1%E8%A8%80%E4%B9%B1%E8%AF%AD/" rel="tag">胡言乱语</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%93%9D%E5%9B%BE/" rel="tag">蓝图</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B7%A8%E5%9F%9F/" rel="tag">跨域</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B7%A8%E5%B9%B3%E5%8F%B0/" rel="tag">跨平台</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B8%A9%E5%9D%91/" rel="tag">踩坑</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%92%93%E9%B1%BC%E7%BD%91%E7%AB%99/" rel="tag">钓鱼网站</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%97%AD%E5%8C%85/" rel="tag">闭包</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E7%BE%A4/" rel="tag">集群</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%99%E6%80%81%E7%BD%91%E7%AB%99/" rel="tag">静态网站</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/" rel="tag">项目管理</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                      <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="https://github.com/msgbyte/tailchat">Tailchat</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">一个兴趣使然的程序员 上海,上班族,27岁. 熟练掌握Nodejs, Html5, C Sharp, Unity技术</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页"></a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页"></a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/show/">作品展示</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:moonrailgun@gmail.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/moonrailgun" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap">
  
    <article id="post-国际标准保留端口列表" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/9ec26053/" class="article-date">
      <time datetime="2024-10-07T06:18:00.809Z" itemprop="datePublished">2024-10-07</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/9ec26053/">国际标准保留端口列表</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <ul>
<li><a target="_blank" rel="noopener" href="https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml">Service Name and Transport Protocol Port Number Registry</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rfc/" rel="tag">rfc</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-记录一次docker占用过大导致磁盘爆炸的问题" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/cee56102/" class="article-date">
      <time datetime="2024-07-15T14:49:01.000Z" itemprop="datePublished">2024-07-15</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/cee56102/">记录一次docker占用过大导致磁盘爆炸的问题</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>通过告警发现磁盘被占满</p>
<h2 id="解决方式"><a href="#解决方式" class="headerlink" title="解决方式"></a>解决方式</h2><p>通过命令行工具 <code>ncdu</code> 发现这个文件过大 <code>/var/lib/docker/containers/92ca12ee784ccd5dc44c367046d72f6c0cae4668e50fae613567dc0f4de024a3/92ca12ee784ccd5dc44c367046d72f6c0cae4668e50fae613567dc0f4de024a3-json.log</code>‘</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ls -lh /var/<span class="class"><span class="keyword">lib</span>/<span class="title">docker</span>/<span class="title">containers</span>/92<span class="title">ca12ee784ccd5dc44c367046d72f6c0cae4668e50fae613567dc0f4de024a3</span>/92<span class="title">ca12ee784ccd5dc44c367046d72f6c0cae4668e50fae613567dc0f4de024a3</span>-<span class="title">json</span>.<span class="title">log</span></span></span><br><span class="line"></span><br><span class="line">-rw-r----- <span class="number">1</span> root root <span class="number">15</span>G Jul <span class="number">15</span> <span class="number">22</span>:<span class="number">37</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">docker</span>/<span class="title">containers</span>/92<span class="title">ca12ee784ccd5dc44c367046d72f6c0cae4668e50fae613567dc0f4de024a3</span>/92<span class="title">ca12ee784ccd5dc44c367046d72f6c0cae4668e50fae613567dc0f4de024a3</span>-<span class="title">json</span>.<span class="title">log</span></span></span><br></pre></td></tr></table></figure>

<p>检查后发现是一个日志文件，占据了 15G 之多.</p>
<p>使用命令 <code>cat /dev/null &gt; /var/lib/docker/containers/92ca12ee784ccd5dc44c367046d72f6c0cae4668e50fae613567dc0f4de024a3/92ca12ee784ccd5dc44c367046d72f6c0cae4668e50fae613567dc0f4de024a3-json.log</code> 将其清理，因为这个文件如果被一直占用的话直接使用<code>rm</code>是不会释放磁盘空间的。因此直接使用 <code>/dev/null</code> 覆盖文件即可实现立即释放空间的作用</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-打工人必备！实现JS控制的SVG渐变图标，让你的页面更加生动有趣 6d2fc205b3df41b3b50eaa4449446364" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/8aed9be/" class="article-date">
      <time datetime="2023-10-12T14:22:01.000Z" itemprop="datePublished">2023-10-12</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/8aed9be/">打工人必备！实现JS控制的SVG渐变图标，让你的页面更加生动有趣</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>在我们开发界面时，有时候渐变的图像会相比固定颜色的图形更加富有层次感与有趣。熟悉css的同学都知道，我们可以通过样式让背景呈现一个线性的渐变图片，比如这样:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.simple-linear</span> &#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(blue, pink);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/misc/231012/1.png"></p>
<p>也可以通过裁剪背景颜色到文本的方式实现文本颜色渐变</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.text-gradient</span> &#123;</span><br><span class="line">  <span class="attribute">background-image</span>: <span class="built_in">linear-gradient</span>(to right, orange, purple);</span><br><span class="line">  <span class="attribute">-webkit-background-clip</span>: text;</span><br><span class="line">  <span class="attribute">color</span>: transparent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/misc/231012/2.png"></p>
<p>这些解决方案都是网络上随便都能搜到的，那么现在背景渐变有了，文本渐变有了，看上去我们似乎可以实现各种渐变了，但是我们还差一个非常常见的元素没有办法做到渐变，那就是svg图标。</p>
<p>目前网络上所能找到的所有关于svg渐变颜色的方案都是需要通过svg本身的配置来实现的。举个例子:</p>
<p>比如这样:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg</span><br><span class="line">  class=&quot;svg-gradient&quot;</span><br><span class="line">  xmlns=&quot;http://www.w3.org/2000/svg&quot;</span><br><span class="line">  width=&quot;24&quot;</span><br><span class="line">  height=&quot;24&quot;</span><br><span class="line">  viewBox=&quot;0 0 24 24&quot;</span><br><span class="line">&gt;</span><br><span class="line">  <span class="tag">&lt;<span class="name">defs</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">linearGradient</span> <span class="attr">y2</span>=<span class="string">&quot;0&quot;</span> <span class="attr">x2</span>=<span class="string">&quot;1&quot;</span> <span class="attr">y1</span>=<span class="string">&quot;1&quot;</span> <span class="attr">x1</span>=<span class="string">&quot;1&quot;</span> <span class="attr">id</span>=<span class="string">&quot;svg_1&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">stop</span> <span class="attr">stop-color</span>=<span class="string">&quot;#ff0000&quot;</span> <span class="attr">offset</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">stop</span> <span class="attr">stop-color</span>=<span class="string">&quot;#ffff00&quot;</span> <span class="attr">offset</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">linearGradient</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">defs</span>&gt;</span></span><br><span class="line">  &lt;path</span><br><span class="line">    d=&quot;M12 2a9 9 0 0 0-9 9v11l3-3l3 3l3-3l3 3l3-3l3 3V11a9 9 0 0 0-9-9M9 8a2 2 0 0 1 2 2a2 2 0 0 1-2 2a2 2 0 0 1-2-2a2 2 0 0 1 2-2m6 0a2 2 0 0 1 2 2a2 2 0 0 1-2 2a2 2 0 0 1-2-2a2 2 0 0 1 2-2Z&quot;</span><br><span class="line">    fill=&quot;url(#svg_1)&quot;</span><br><span class="line">  /&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/misc/231012/3.png"></p>
<p>这看上去很美好，因为我们我们只需要把这段svg代码复制到我们的项目中，然后需要的时候引用一下就好了。</p>
<p>当然是可以，但是在实际开发中我们往往会遇到更加复杂的挑战。比如我们用的图标是在一个图标库组件中，我们没有办法去直接修改（比如 <code>react-icons</code> ）。比如我们需要让图标在渐变色(选中状态)和单色(未选中状态)之间来回切换。</p>
<p>难道我要准备两个一样的仅仅颜色不一样的图标因为状态来选择使用哪个图标么？这很丑陋，且难以维护。</p>
<p>想象一下我们是如何使用单色图标的？仅仅配置 <code>color=#&lt;hex-color&gt;</code> 即可实现不同颜色的切换。为什么渐变色图标不能有类似方式？</p>
<p>我搜索了网络上所有的资料，但是我没有找到我想要的方法，因此我决定自己探索。</p>
<p>一个很少有人会注意到的事实是，<code>&lt;defs&gt;</code> 标签的定义作用域不是父级的svg节点而是整个文档流。因此我们可以跨多个svg声明共用一个svg定义。然后只需要通过固定的id就可以了。</p>
<p>具体方案如下:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">  <span class="selector-class">.svg-gradient</span> &#123;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">fill</span>: <span class="selector-tag">url</span>(<span class="selector-id">#my-gradient</span>);</span></span><br><span class="line">	&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">&quot;0&quot;</span> <span class="attr">height</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">defs</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">linearGradient</span> <span class="attr">y2</span>=<span class="string">&quot;0&quot;</span> <span class="attr">x2</span>=<span class="string">&quot;1&quot;</span> <span class="attr">y1</span>=<span class="string">&quot;1&quot;</span> <span class="attr">x1</span>=<span class="string">&quot;1&quot;</span> <span class="attr">id</span>=<span class="string">&quot;my-gradient&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">stop</span> <span class="attr">stop-color</span>=<span class="string">&quot;#ff0000&quot;</span> <span class="attr">offset</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">stop</span> <span class="attr">stop-color</span>=<span class="string">&quot;#ffff00&quot;</span> <span class="attr">offset</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">linearGradient</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">defs</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;svg</span><br><span class="line">  class=&quot;svg-gradient&quot;</span><br><span class="line">  xmlns=&quot;http://www.w3.org/2000/svg&quot;</span><br><span class="line">  width=&quot;24&quot;</span><br><span class="line">  height=&quot;24&quot;</span><br><span class="line">  viewBox=&quot;0 0 24 24&quot;</span><br><span class="line">&gt;</span><br><span class="line">  &lt;path</span><br><span class="line">    d=&quot;M12 2a9 9 0 0 0-9 9v11l3-3l3 3l3-3l3 3l3-3l3 3V11a9 9 0 0 0-9-9M9 8a2 2 0 0 1 2 2a2 2 0 0 1-2 2a2 2 0 0 1-2-2a2 2 0 0 1 2-2m6 0a2 2 0 0 1 2 2a2 2 0 0 1-2 2a2 2 0 0 1-2-2a2 2 0 0 1 2-2Z&quot;</span><br><span class="line">  /&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>只需要我们把第一个表示颜色定义的svg放在全局预先加载，然后给定义的渐变色起一个有意义的名字，然后我们就可以在任意地方直接在svg的样式上告知需要采用的fill颜色即可 <code>fill: url(#my-gradient);</code></p>
<p>颜色的切换就变成了 <code>fill</code> 属性的切换，这样就和单色图标一样了。</p>
<p>需要注意的是需要给用于声明的svg的宽高设为0，不然浏览器会给一个默认的宽高，会影响整体的布局。</p>
<p>最终看下成品效果:</p>
<p><img src="/images/misc/231012/4.gif"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gradient/" rel="tag">gradient</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/svg/" rel="tag">svg</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-你可能不需要微前端，但你一定会需要微内核" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/cecd0a5c/" class="article-date">
      <time datetime="2023-05-24T11:20:36.000Z" itemprop="datePublished">2023-05-24</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/cecd0a5c/">你可能不需要微前端，但你一定会需要微内核</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="先聊聊微前端"><a href="#先聊聊微前端" class="headerlink" title="先聊聊微前端"></a>先聊聊微前端</h2><p>阿里巴巴的一篇 <a target="_blank" rel="noopener" href="https://juejin.cn/post/7185070739064619068">为iframe正名，你可能并不需要微前端</a> 又将社区的风向一转，当初大力推销微前端概念的阿里巴巴又主动跳出来说微前端未必好用。</p>
<p>虽然不知道阿里巴巴内部发生了什么，但是同样作为一名在工作中深度使用微前端框架的前端码农来说，我想我也逐步触及了微前端的限制。</p>
<p>微前端，简单来说就是把原来iframe实现的隔离机制用js实现了一遍。其背景是为了解决多个团队同时修改一套系统可能带来的项目管理问题，</p>
<p>而微前端的好处在于，iframe的隔离是完全隔离，而微前端是一个可控的隔离。即在某些情况下可以分享一些内容。</p>
<p>微前端的架构往往是由一个基座项目为中心，加上若干个子项目组成。而子项目与子项目之间有一些内容是可以共享的，比如说组件库，公共依赖，缓存管理，权限管理等。这是微前端给我们带来的好处与优势。而曾经的iframe方案则很难做到这一点。</p>
<p>至于iframe方案和微前端的方案的优劣在此不再赘述，但是我想带大家了解一下更容易被我们忽略的东西</p>
<h2 id="什么是微内核"><a href="#什么是微内核" class="headerlink" title="什么是微内核"></a>什么是微内核</h2><p>在了解了什么是微前端后，我想向大家介绍一下微内核的概念。</p>
<p>什么是微内核？即以一个核心服务为中心，然后将所有的业务当做一个可插拔的插件。</p>
<p><img src="/images/misc/230524/1.png"></p>
<p>这种架构是不是非常眼熟？没错我们经常用的 <code>vscode</code> 也是这样的微内核框架，<code>vscode</code> 的核心就是一个文本编辑器，然后配套上一个拓展中心用于加载插件。</p>
<p>而像是主题、语言支持、格式化工具以及各种第三方工具面板，都是一个个独立的外部插件。正是因为完整的插件生态造成了 <code>vscode</code> 的成功。而 <code>vscode</code> 的插件系统就是一种微内核架构。</p>
<p>而回过头想想，微前端又何尝不是一种特殊的微内核解决方案呢？微前端无非是基于路由的、限定同时只能加载一个子应用(插件)，具备沙盒机制的微内核框架。</p>
<h2 id="微内核架构可以给我们带来什么"><a href="#微内核架构可以给我们带来什么" class="headerlink" title="微内核架构可以给我们带来什么"></a>微内核架构可以给我们带来什么</h2><p>在谈论微内核架构时，我们得先抛开一切上下文。聊聊微内核架构的设计理念。</p>
<blockquote>
<p>将系统的实现，与系统的基本操作规则区分开来。它实现的方式是将核心功能模块化，划分成几个独立的进程，各自运行，这些进程被称为服务。所有的服务进程，都运行在不同的地址空间。</p>
</blockquote>
<blockquote>
<p>让服务各自独立，可以减少系统之间的耦合度，易于实现与除错，也可以增进可移植性。它可以避免单一组件失效，而造成整个系统崩溃，内核只需要重启这个组件，不至于影响其他服务器的功能，使系统稳定度增加。同时业务功能可以视需要，抽换或新增某些服务进程，使功能更有弹性。</p>
</blockquote>
<blockquote>
<p>就代码数量来看，一般来说，因为功能简化，核心系统使用的代码比集成式系统更少。更少的代码意味更少的潜藏程序bug。</p>
</blockquote>
<p>在长期使用微前端的过程中我们也能发现其好处，业务代码再怎么发生改变，也不会影响整体系统的稳定性。而相比于微前端，微内核的设计抽象度会更加复杂一点，相对的，两者的交流也会更加频繁一点，自由度也会更加高。</p>
<p>相比于微前端固定位置，共享部分依赖的简单场景来说，微内核的核心系统会更加复杂一点。我们依旧是以 <code>vscode</code> 为例， <code>vscode</code> 需要抽象化他的核心系统，可以支持各种插件的功能，比如为系统的各个内容、token做标记，以支持各类主题的接入。为各种语言服务做抽象层，以兼容不同语言的需求等等。</p>
<p>这也是为什么这类做插件系统的应用很少。因为虽然大家都知道插件系统能够带来各种各样的好处，但是因为设计的复杂性导致愿意去做的人比较少。当然，这个复杂度是针对核心系统的，对于插件的开发者来说并不会感知到，而是可以直接使用成熟的核心系统提供的能力快速进行开发。相信开发过 <code>vscode</code> 的同学都不需要了解内核系统是怎么运作的。</p>
<p>当然，在日常的使用我们也有用到微内核的概念。常见的例子就是各类orm支持不同的数据库，然后我们通过一个适配层将通用的orm根据不同的数据库实现进行适配。</p>
<p>再比如飞书文档支持各类第三方内容块，而这些第三方内容块就是一个个插件。只需要统一的协议来约定交互行为即可。</p>
<p>所以为什么我说我们需要微内核架构呢？微内核架构更多的是一种设计思路，很多时候我们愿意去写集成式的应用，往往随着代码的迭代整个系统的复杂度越来越高、越来越难以维护。变成一个巨石应用，也往往被后来的维护者称为屎山代码。而如果我们前期就做好一定的抽象，那么随着时间而增加的代码复杂度的增长幅度也会逐渐趋于稳定。</p>
<p><img src="/images/misc/230524/2.png"></p>
<h2 id="那么有什么实现微内核架构的库呢"><a href="#那么有什么实现微内核架构的库呢" class="headerlink" title="那么有什么实现微内核架构的库呢"></a>那么有什么实现微内核架构的库呢</h2><p>当然有。</p>
<p>mini-star(<a target="_blank" rel="noopener" href="https://ministar.moonrailgun.com/">https://ministar.moonrailgun.com/</a>) 就是一个可以满足想要构建微内核架构的库。</p>
<p><code>mini-star</code> 只做一个微内核库该做的事情，即插件构建、加载、与依赖共享。</p>
<p>相比于微前端的基于路由的、同时只能运行一个子应用的限制，<code>mini-star</code> 并没有对开发者做任何的限制，也就是说并没有做任何预设的场景限制。如微前端因为其限制更多的还是用在后台应用上，而作为微内核库的 <code>mini-star</code> 则可以用在任何场景。</p>
<p><code>mini-star</code> 提供了运行时加载器(runtime), 插件编译器(bundler) 和命令行工具(cli)。从全链路支持插件系统的开发。</p>
<h3 id="编译生态"><a href="#编译生态" class="headerlink" title="编译生态"></a>编译生态</h3><p><code>mini-star</code> 的编译器依托于 <code>Rollup</code> 。因此可以直接复用现成的rollup生态对代码做优化。当然 <code>mini-star</code> 已经内置了一部分常用的编译插件，开箱即用。</p>
<h3 id="懒加载"><a href="#懒加载" class="headerlink" title="懒加载"></a>懒加载</h3><p><code>mini-star</code> 的内核加载系统约定了插件和加载器运行时的规则，在运行时统一采用了类amd加载策略，因此依赖是可以收集以及被感知的，一个插件编译产物的结构如下:</p>
<p>源文件</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源文件:</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@capital/any&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// some logic</span></span><br></pre></td></tr></table></figure>

<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编译后的文件:</span></span><br><span class="line">definePlugin(<span class="string">&#x27;@plugins/foo&#x27;</span>, [<span class="string">&#x27;@capital/any&#x27;</span>], (<span class="function"><span class="keyword">function</span> (<span class="params">any</span>) </span>&#123;</span><br><span class="line">	<span class="comment">// some logic</span></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<p>因此， <code>mini-star</code> 支持依赖懒加载，而如 <code>qiankun</code>、 <code>garfish</code> 这种使用webpack的external机制进行共享的微前端框架是不支持的。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">regSharedModule(</span><br><span class="line">  <span class="string">&#x27;@capital/any&#x27;</span>,</span><br><span class="line">  () =&gt; <span class="keyword">import</span>(<span class="string">&#x27;./any&#x27;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>更多的可以访问 <code>mini-star</code> 官网了解更多: <a target="_blank" rel="noopener" href="https://ministar.moonrailgun.com/">https://ministar.moonrailgun.com/</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mini-star/" rel="tag">mini-star</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BE%AE%E5%86%85%E6%A0%B8/" rel="tag">微内核</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BE%AE%E5%89%8D%E7%AB%AF/" rel="tag">微前端</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-利用 webpack-stats-viewer 分析 react-virtualized 摇树优化失效问题" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/8a830324/" class="article-date">
      <time datetime="2023-03-31T07:51:34.000Z" itemprop="datePublished">2023-03-31</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/8a830324/">利用 webpack-stats-viewer 分析 react-virtualized 摇树优化失效问题</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在项目性能优化过程中，发现 react-virtualized 依赖过重，经过初步分析是因为react-virtualized 虽然只是引用了部分功能，但是实际打包的时候将所有的代码都打包导入了。</p>
<p>我们起一个新的项目看一下。</p>
<p>在入口文件我们仅仅使用导入一个List功能。然后仅仅是打印一下，看看结果。</p>
<p><img src="/images/webpack/react-virtualized/1.png" alt="1.png"></p>
<p><img src="/images/webpack/react-virtualized/2.png" alt="2.png"></p>
<p>可以看到，通过<code>webpack-bundle-analyzer</code> 的分析，我们可以看到 <code>react-virtualized</code> 这个包被完全打包打进了产出中，尽管没有用到里面任何的东西。</p>
<p>了解 esmodule 这种打包方式的都应该知道摇树优化(Tree Shaking)。当我们通过 esmodule 的方式引入一个支持 esmodule 的包时，不被使用的包会被移除，以减少最终产物的体积。在<code>react-virtualized</code> 的路径中，我们可以很明显的发现我们引入的代码文件都是在 es 目录下的，这意味着这个包是支持 esmodule 的，尽管我们只用了 <code>react-virtualized</code> 这个包，其他不相关的代码依旧被打包进去了。</p>
<p>很显然，在 <code>react-virtualized</code> 这个库中，我们的摇树优化失效了。通过 <code>webpack-bundle-analyzer</code> 我们可以很轻易的看出这一点，然而更加深入的信息我们就不得而知了。</p>
<h2 id="排查问题"><a href="#排查问题" class="headerlink" title="排查问题"></a>排查问题</h2><p>为了解决问题，我们需要知道为什么会发生这样的事情，因此接下来我们要用到一个新的工具 —— <code>webpack-stats-viewer-plugin</code></p>
<p>使用方式如下:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -D webpack-stats-viewer-plugin</span><br></pre></td></tr></table></figure>

<p><img src="/images/webpack/react-virtualized/3.png" alt="3.png"></p>
<p>在每次 webpack 打包后，都会在输出目录生成一份打包报告。我们可以直接点开生成的报告看一下。大概内容是这样的:</p>
<p><img src="/images/webpack/react-virtualized/4.png" alt="4.png"></p>
<p>相比于比较注重美观的网格树来说，列表的显示更加直白与清晰。列表中的每个项都是一个独立的chunk, 列表显示了这个chunk打包出来的文件名，大小，以及chunk间的引用关系(父 chunks, 子 chunks, 和 同级chunks)。因为本例非常简单所以只有一个chunk，在这里我们要对单个chunk进行分析，在之前我们看到了 <code>react-virtualized</code> 已经被全部打进去了，所以我们要找到 <code>react-virtualized</code> 摇树优化失效的原因。这里我们点开 <code>modules</code> 功能看一下</p>
<p><img src="/images/webpack/react-virtualized/5.png" alt="5.png"></p>
<p>在弹出的popup中我们可以看到这个chunk包含的完整的模块列表，我们随便点开一个 <code>react-virtualized</code> 的模块</p>
<p><img src="/images/webpack/react-virtualized/6.png" alt="6.png"></p>
<p>我们可以详细的看到一个模块的引用路径，引用原因，以及导入原因，以及一些优化建议。</p>
<p>需要注意的是黄色警告的内容，提示 <code>No export used, maybe has side effect</code> 。这就是我们主要要解决的问题，虽然这个模块提供了esmodule，但是却依旧会把所有的内容打包进去(尽管没有任何代码被引用)。</p>
<p>我们看一下这个文件, 在建议中提示我们第一行有副作用，我们进去看一下</p>
<p><img src="/images/webpack/react-virtualized/7.png" alt="7.png"></p>
<p>在这里的第一行是个默认导出，我们继续跳转进去看一下</p>
<p>按照工具给出的提示，我们可以看到这个变量声明是具有副作用的</p>
<p><img src="/images/webpack/react-virtualized/8.png" alt="8.png"></p>
<p><img src="/images/webpack/react-virtualized/9.png" alt="9.png"></p>
<p>看起来是因为一个 <code>/*#**PURE***/</code> 标记无法处理连续的赋值操作导致编译的时候失效。</p>
<p>另一方面我们可以很明显发现有一些编译时注入的代码，</p>
<p><img src="/images/webpack/react-virtualized/10.png" alt="10.png"></p>
<p>这些代码是编译时babel注入的polyfill，而当我们跳转过去看一下会发现这些内容不能满足esmodule的要求，require语法在摇树优化时会因为无法被正确的处理，为了确保整体代码不会出问题，因此webpack会把require所包含的内容一起打进去。</p>
<p><img src="/images/webpack/react-virtualized/11.png" alt="11.png"></p>
<p>两方原因造成了<code>react-virtualized</code> 没有被使用的代码在引入时都被打包进去了，而类似的原因在这个库中到处都是。</p>
<p>这也难怪这个包的es 不生效了。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>解决方法很简单，就是直接通过es的引入方式来引入, 如:</p>
<p><img src="/images/webpack/react-virtualized/12.png" alt="12.png"></p>
<p><img src="/images/webpack/react-virtualized/13.png" alt="13.png"></p>
<p><img src="/images/webpack/react-virtualized/14.png" alt="14.png"></p>
<p>此时我们再看打包后的内容就干净了很多。</p>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><p>演示项目: <a target="_blank" rel="noopener" href="https://stackblitz.com/edit/github-rx5vpd">https://stackblitz.com/edit/github-rx5vpd</a></p>
<p>webpack-stats-viewer: <a target="_blank" rel="noopener" href="https://github.com/moonrailgun/webpack-stats-viewer">https://github.com/moonrailgun/webpack-stats-viewer</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react-virtualized/" rel="tag">react-virtualized</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webpack/" rel="tag">webpack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webpack-stats-viewer/" rel="tag">webpack-stats-viewer</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" rel="tag">性能优化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%91%87%E6%A0%91%E4%BC%98%E5%8C%96/" rel="tag">摇树优化</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-React Query 简明设计哲学入门指北" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/6c6ef04/" class="article-date">
      <time datetime="2023-03-09T11:35:11.000Z" itemprop="datePublished">2023-03-09</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/6c6ef04/">React Query 简明设计哲学入门指北</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><img src="/images/react-query/1.png"></p>
<blockquote>
<p>Github <a target="_blank" rel="noopener" href="https://github.com/TanStack/query">https://github.com/TanStack/query</a> 33k star</p>
<p>官方文档 <a target="_blank" rel="noopener" href="https://react-query-v3.tanstack.com/">https://react-query-v3.tanstack.com/</a></p>
</blockquote>
<h2 id="0x00-首先，为什么我们需要React-Query"><a href="#0x00-首先，为什么我们需要React-Query" class="headerlink" title="0x00 首先，为什么我们需要React Query"></a>0x00 首先，为什么我们需要React Query</h2><p>顾名思义，React Query 是一个请求库，但是这个命名并不准确，因为这个请求库本身并不处理请求 —— 他本身不会以任何方式向外发起任何请求。相比请求库，他更像是一个请求缓存层。</p>
<p>一个简单的使用大概是这样的：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Example</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="keyword">const</span> &#123; isLoading, error, data &#125; = useQuery(<span class="string">&#x27;repoData&#x27;</span>, <span class="function">() =&gt;</span></span><br><span class="line">     fetch(<span class="string">&#x27;https://api.github.com/repos/tannerlinsley/react-query&#x27;</span>).then(<span class="function"><span class="params">res</span> =&gt;</span></span><br><span class="line">       res.json()</span><br><span class="line">     )</span><br><span class="line">   )</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (isLoading) <span class="keyword">return</span> <span class="string">&#x27;Loading...&#x27;</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (error) <span class="keyword">return</span> <span class="string">&#x27;An error has occurred: &#x27;</span> + error.message</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> (</span><br><span class="line">     &lt;div&gt;</span><br><span class="line">       &lt;h1&gt;&#123;data.name&#125;&lt;/h1&gt;</span><br><span class="line">       &lt;p&gt;&#123;data.description&#125;&lt;/p&gt;</span><br><span class="line">       &lt;strong&gt;👀 &#123;data.subscribers_count&#125;&lt;/strong&gt;&#123;<span class="string">&#x27; &#x27;</span>&#125;</span><br><span class="line">       &lt;strong&gt;✨ &#123;data.stargazers_count&#125;&lt;/strong&gt;&#123;<span class="string">&#x27; &#x27;</span>&#125;</span><br><span class="line">       &lt;strong&gt;🍴 &#123;data.forks_count&#125;&lt;/strong&gt;</span><br><span class="line">     &lt;/div&gt;</span><br><span class="line">   )</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>相比于一般的在组件中发起请求，React Query通过 <code>useQuery</code> 帮我们自然而然的生成了一个请求中间层。</p>
<p>原始:</p>
<p><img src="/images/react-query/2.png"></p>
<p>使用React Query后:</p>
<p><img src="/images/react-query/3.png"></p>
<p>而从单个请求来看的话，似乎增加了这一层以后没有任何的收益</p>
<p>那么我们拓展一下呢?</p>
<p><img src="/images/react-query/4.png"></p>
<p>可以看到，通过一个中间的缓存层，我们可以把相同的组件同时发出的多个同样的请求合并成一个发送给服务端，这样对于服务端来说请求压力会减少很多。</p>
<p>但是，我们完全可以把相同的请求放在同一个地方，然后把结果传递给使用的组件，那么是不是就完全不需要面对这种情况了呢？</p>
<p>是的，我们在大部分时间做的就是这样的方式，很少会出现相同的请求发送很多遍的情况。但是这也是我要说的React Query通过中间层带给我们的最大的意义 —— 解耦。</p>
<p>想象一下，我们有以下这样的组件:</p>
<p><img src="/images/react-query/5.png"></p>
<p>分别代表了用户信息组件，用户简单信息列表项，以及他们组合的产物。他们都需要获取最新的用户信息，用的是同样的接口。我们分别叫他们组件A，组件B和组件C吧。</p>
<p>当我们单独处理组件A和组件B时，我们只需要在组件挂载阶段去获取远程的数据即可。这非常容易，但如何我们将他们组件使用以后，一些问题就会出现了：我们不可能让他发起两次同样的请求，按照我们之前的做法，我们就需要在组件B渲染的阶段把数据拿到，然后在组件A弹出的时候将组件B获取到的数据传递进去。</p>
<p>这很容易，但是这也带来了上下文。即组件A既有自己获取数据的逻辑，又有根据上下文获取数据的逻辑。这种方式的数据管理是复杂的，难以维护的。</p>
<p>而通过React Query带来的缓存层，我们就无需关心请求的细节，每个组件都可以只关心自己的事情而无需关心上下文。所有的请求将会由一个统一的缓冲层来帮助我们统一管理请求数据。</p>
<h2 id="0x01-数据活性"><a href="#0x01-数据活性" class="headerlink" title="0x01 数据活性"></a>0x01 数据活性</h2><p>大家都知道，数据是有时效性的。在我们的HTTP协议中带来了一个新鲜度的概念，即在每次请求中标注一下一个请求的时效性，就类似食品的保质期一样。相比于缓存，我更加喜欢用数据活性这个概念，因为数据是有生命周期的。</p>
<p>在时效性有效的范围内，我们可以认为请求的资源是“新鲜的”，那么我们就可以在下次发送网络请求的时候不再向远程发送请求，而是使用本地记录的上一条结果。而如果请求的时间过了时效范围，那么这个请求将会被标记为“陈旧的”，那么再发起新的请求以后，就会真实的向服务器发送网络请求。这就是我们一般意义上的缓存。</p>
<p>而在<code>service worker</code>中, 有一种新的网络缓存管理概念，名为: <code>Stale-while-revalidate</code></p>
<p>其意义上在于，在<code>service worker</code>代理网络请求的时候，为了确保用户每次都能非常快速的加载页面，sw会第一时间去从本地缓存中拿取数据返回给页面，但是同时在后台发送真实的网络请求去获取最新的内容并更新本地缓存。这样用户不会第一时间拿到最新的数据，而是以最快的速度打开页面，而在后台请求以确保下次的内容更新。</p>
<p><img src="/images/react-query/6.png"></p>
<blockquote>
<p>更多详细说明: <a target="_blank" rel="noopener" href="https://developer.chrome.com/docs/workbox/caching-strategies-overview/#stale-while-revalidate">https://developer.chrome.com/docs/workbox/caching-strategies-overview/#stale-while-revalidate</a></p>
</blockquote>
<p>而<code>React Query</code> 在这方面做的更加好，相比于<code>Promise</code>的一次性的数据获取，<code>hooks</code>带来了允许主动发起的多次数据更新。这意味着<code>React Query</code>能做到更加复杂的数据更新策略。</p>
<p><img src="/images/react-query/7.png"></p>
<p>上图则是<code>React Query</code>在进行“陈旧”数据的处理方式，如果一条请求被标记为“陈旧”而不是“过期”，那么在 <code>hooks</code> 中，<code>React Query</code>会第一时间将旧的数据返回给前端，与此同时再向服务器发送网络请求，当网络请求的结果回来后，通过<code>hooks</code> 再一次更新数据。</p>
<p>对于标记的“陈旧”与“过期”的概念，就是在请求的时候定义的“slateTime” 与 “cacheTime”，区别就在于如果之前请求过，是否要第一时间返回到前端，然后二次更新最新的数据，还是选择直接等着网络的返回。可以看得出非常精确了。</p>
<p>同时，如果一个组件挂载后很长时间不更新，但是新的组件被更新数据以后，旧的组件也会同样更新保持数据一致性，用户在管理数据方面就没有任何压力了。</p>
<h2 id="0x02-不仅仅是-react-与-query"><a href="#0x02-不仅仅是-react-与-query" class="headerlink" title="0x02 不仅仅是 react 与 query"></a>0x02 不仅仅是 react 与 query</h2><p>坦白的讲，<code>React Query</code>的名字起的并不好。在我上面的讲述中大家可以发现，React Query做的其实并不是query的事情而是cache的事情，我们可以在其中管理任何的异步操作，比如一个高CPU的算法，比如一个与web worker的通讯结果。</p>
<p>另一方面，<code>React Query</code> 与 <code>React</code> 的关系在于他通过 react hooks 实现的数据响应式更新。然而其实什么方式并不重要，如果我们做一些抽象是不是能够作用到任何的数据驱动的框架中呢？事实上新版的<code>React Query</code> 也是这么做的。</p>
<p><img src="/images/react-query/8.png"></p>
<p>可以看到在新的结构中，拆分了内核包与各种框架的适配层。</p>
<p>这就是为什么我说他的名字起的并不好，具有很强的误导性。react query，即跟react无关，又与query没有直接关系。只能说历史原因难以修改，这也是为什么我在平时的工作中一直强调尽可能的减少技术负债，因为有的技术负债一旦背上可能就永远摆脱不掉了。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React-Query/" rel="tag">React Query</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/" rel="tag">状态管理</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-小即是美 —— 简约而不简单的状态管理工具zustand" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/14043fbf/" class="article-date">
      <time datetime="2022-12-13T09:27:12.000Z" itemprop="datePublished">2022-12-13</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/14043fbf/">小即是美 —— 简约而不简单的状态管理工具zustand</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>我用过或了解过前端业界大部分流行的状态管理库。他们有的很复杂，有的很简单。有的用了一些深度改造的手段来优化细节，有的则是平铺直叙的告诉所有使用者发生了变化。在技术方案诡异多变与层出不穷的当下，只有一个状态管理库让我深深着迷，她极度精简到让我觉得不能再简单了，但是她也足够完备到应对任何场景。而我就一直在追究这样的一个宛如艺术品一样的状态管理库，经过一段时间的使用，我很确定她就是我的梦中情库。</p>
<p>她的名字叫 <code>zustand</code></p>
<p>Github: <a target="_blank" rel="noopener" href="https://github.com/pmndrs/zustand">https://github.com/pmndrs/zustand</a></p>
<h2 id="极简定义"><a href="#极简定义" class="headerlink" title="极简定义"></a>极简定义</h2><p>我们先看看其他业界的状态管理库的使用方式:</p>
<p>以比较主流的<code>redux</code>和<code>mobx</code>为例, 这里直接复制了官网的最小示例。</p>
<p><strong>redux(@reduxjs/toolkit)</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createSlice, configureStore &#125; <span class="keyword">from</span> <span class="string">&quot;@reduxjs/toolkit&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> counterSlice = createSlice(&#123;</span><br><span class="line">  name: <span class="string">&quot;counter&quot;</span>,</span><br><span class="line">  initialState: &#123;</span><br><span class="line">    value: <span class="number">0</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  reducers: &#123;</span><br><span class="line">    incremented: <span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">      state.value += <span class="number">1</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    decremented: <span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">      state.value -= <span class="number">1</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> &#123; incremented, decremented &#125; = counterSlice.actions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = configureStore(&#123;</span><br><span class="line">  reducer: counterSlice.reducer,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">store.subscribe(<span class="function">() =&gt;</span> <span class="built_in">console</span>.log(store.getState()));</span><br><span class="line">store.dispatch(incremented());</span><br><span class="line">store.dispatch(incremented());</span><br><span class="line">store.dispatch(decremented());</span><br></pre></td></tr></table></figure>

<p><strong>mobx</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">&quot;react-dom&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; makeAutoObservable &#125; <span class="keyword">from</span> <span class="string">&quot;mobx&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; observer &#125; <span class="keyword">from</span> <span class="string">&quot;mobx-react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Timer</span> </span>&#123;</span><br><span class="line">  secondsPassed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    makeAutoObservable(<span class="built_in">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">increase</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.secondsPassed += <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">reset</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.secondsPassed = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myTimer = <span class="keyword">new</span> Timer();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Build a &quot;user interface&quot; that uses the observable state.</span></span><br><span class="line"><span class="keyword">const</span> TimerView = observer(<span class="function">(<span class="params">&#123; timer &#125;</span>) =&gt;</span> (</span><br><span class="line">  &lt;button onClick=&#123;<span class="function">() =&gt;</span> timer.reset()&#125;&gt;</span><br><span class="line">    Seconds passed: &#123;timer.secondsPassed&#125;</span><br><span class="line">  &lt;/button&gt;</span><br><span class="line">));</span><br><span class="line"></span><br><span class="line">ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">TimerView</span> <span class="attr">timer</span>=<span class="string">&#123;myTimer&#125;</span> /&gt;</span></span>, <span class="built_in">document</span>.body);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Update the &#x27;Seconds passed: X&#x27; text every second.</span></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  myTimer.increase();</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>在 <code>redux</code> 中，我们需要先构建 <code>reducer</code> 来记录如何处理状态，然后根据<code>reducer</code>构建一个<code>store</code>。取值是通过<code>store</code>来获取，修改则需要通过 基于<code>reducer</code>一一对应的<code>action</code>来修改。<br>这样就确保了数据流永远是单向流动的: 即 <code>UI -&gt; action -&gt; reducer -&gt; state -&gt; UI</code> 这样的过程。其响应式的实现就是在执行<code>action -&gt; reducer</code>的过程中收集到了变化，然后通知所有订阅这个<code>store</code>的所有人。然后订阅者再通过名为<code>selector</code>的函数来比对变更决定自身是否要更新。</p>
<p>如:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Foo = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  useSelector(<span class="function"><span class="params">state</span> =&gt;</span> state.count.value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们再来看看另一派的实现: <code>mobx</code> 定义了一个 <code>class</code> 作为存储数据的<code>store</code>, 而对于数据的任何修改都是用一种类似原生的方式 —— 直接赋值来实现的。即既可以直接访问<code>store</code>中修改里面的值也可以通过调用<code>store</code>暴露出的方法来修改数据。而数据的取值也是直接通过最简单的数据访问来实现的。<br>看上去非常美好，但是这是通过一些”黑魔法”来实现的，当执行<code>makeAutoObservable(this)</code>的那一刻，原来的成员变量已经不是原来的数据了，已经变成了由<code>mobx</code>包裹了一层实现的 <strong>可观察对象</strong>, 即这些对象的赋值与取值都不是原来的含义了。这也就是为什么<code>mobx</code>可以实现<code>reactive</code>响应式的原因。</p>
<p>这时候我们再来看看<code>zustand</code>是怎么做的:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> create <span class="keyword">from</span> <span class="string">&#x27;zustand&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> useBearStore = create(<span class="function">(<span class="params">set</span>) =&gt;</span> (&#123;</span><br><span class="line">  bears: <span class="number">0</span>,</span><br><span class="line">  increasePopulation: <span class="function">() =&gt;</span> set(<span class="function">(<span class="params">state</span>) =&gt;</span> (&#123; <span class="attr">bears</span>: state.bears + <span class="number">1</span> &#125;)),</span><br><span class="line">  removeAllBears: <span class="function">() =&gt;</span> set(&#123; <span class="attr">bears</span>: <span class="number">0</span> &#125;),</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">BearCounter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> bears = useBearStore(<span class="function">(<span class="params">state</span>) =&gt;</span> state.bears)</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;bears&#125; around here ...<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Controls</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> increasePopulation = useBearStore(<span class="function">(<span class="params">state</span>) =&gt;</span> state.increasePopulation)</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;increasePopulation&#125;</span>&gt;</span>one up<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>是的，只需要简单的一个对象就定义了一个<code>store</code>，不需要特意去区分是<code>state</code>还是<code>action</code>, 也不需要特意去构造一个 <code>class</code> 来做的非常臃肿。<code>zustand</code> 就是用最简单的设计去做一些事情，甚至其核心代码只有<code>500</code>行不到。</p>
<blockquote>
<p>redux本身最核心的代码只有200行左右，但是如果要在react中使用需要加上<code>redux-react</code>和<code>@reduxjs/toolkit</code> 就远远超过了</p>
</blockquote>
<p>另外可以注意到的是，<code>zustand</code>天生设计了一种场景就是<code>react</code>环境。其他”有野心”的状态管理库往往是从 <code>vanilla</code> 环境(纯js环境)开始设计，然后增加了对<code>react</code>的支持，可能后续还会增加其他框架的支持。但是<code>zustand</code>则不是，天生支持了<code>react</code>环境，然后基于<code>react</code>环境再衍生出<code>vanilla</code>环境的支持。</p>
<p>那么很多人就会好奇，既然都支持<code>vanilla</code>和<code>react</code>，那么从哪个环境开始设计有什么区别么？</p>
<p>答案是有的，从不同的环境开始会从底层设计上就带来很大的偏差，最后落地到使用方来说就是基本使用需要调用的代码、运行时以及复杂度的差异。在我过去的开发经验告诉我这样是正确的，我几乎没有看见过哪个库能同时在多个框架中都能如鱼得水的。不同的框架会有不同的生态，而哪些特有的生态则是最贴合的，如<code>redux</code>之于<code>react</code>，<code>pinia</code>之于<code>vue</code>, <code>rxjs</code>之于<code>Angular</code>。很少有哪个库能够在多个环境中”讨好”的。因此<code>zustand</code>就一种非常聪明的做法，专注于一点非常重要。</p>
<p>那么回到<code>zustand</code>的基本使用，我们可以看到<code>zustand</code>通过<code>create</code>导出的是一个 <code>react hook</code>, 通过这个<code>hook</code> 我们可以直接拿到store里面的<code>state</code>和<code>action</code>，非常类似于<code>redux</code>的<code>useSelector</code>。不同的是不需要<code>dispatch</code>来推送<code>action</code>, 也没有任何模板代码，数据类型天生区分了<code>state</code>和<code>action</code>, 只需要最简单的调用即可。</p>
<p>相比于<code>mobx</code>, 也没有什么”黑魔法”, 简单而不容易出错。而且也不像<code>mobx</code>会因为依赖<code>class</code>实现的<code>store</code>而引入天然的问题(比如作为数据store不应该有生命周期，而<code>class</code>的<code>constructor</code>天生就成为了生命周期的一种)</p>
<blockquote>
<p>人的恐惧往往来自未知，<code>mobx</code> 的对象就是这样的一个黑盒。这就是我不怎么喜欢 <code>mobx</code>的原因</p>
</blockquote>
<h2 id="那么，怎么应用到所有场景呢"><a href="#那么，怎么应用到所有场景呢" class="headerlink" title="那么，怎么应用到所有场景呢"></a>那么，怎么应用到所有场景呢</h2><p><code>zustand</code>是一种非常简单的实现，简单到让人觉得是不是总有一些场合是无法覆盖到的。而这就是我觉得<code>zustand</code>是一件艺术品的原因。因为他总有巧妙的方式来不失优雅的适配任何我想要的场景。</p>
<h3 id="在纯js中调用-可以"><a href="#在纯js中调用-可以" class="headerlink" title="在纯js中调用? 可以"></a>在纯js中调用? 可以</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useBearStore.getState()</span><br></pre></td></tr></table></figure>

<p>通过<code>getState</code>方式就可以获取最新的状态，在使用的过程中需要注意这是一个函数，目的是在运行时中获取到最新的值。里面的数据不是<code>reactive</code>的。</p>
<h3 id="想要有作用域-可以"><a href="#想要有作用域-可以" class="headerlink" title="想要有作用域? 可以"></a>想要有作用域? 可以</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import &#123; createContext, useContext &#125; from &#39;react&#39;</span><br><span class="line">import &#123; createStore, useStore &#125; from &#39;zustand&#39;</span><br><span class="line"></span><br><span class="line">const store &#x3D; createStore(...) &#x2F;&#x2F; vanilla store without hooks</span><br><span class="line"></span><br><span class="line">const StoreContext &#x3D; createContext()</span><br><span class="line"></span><br><span class="line">const App &#x3D; () &#x3D;&gt; (</span><br><span class="line">  &lt;StoreContext.Provider value&#x3D;&#123;store&#125;&gt;</span><br><span class="line">    ...</span><br><span class="line">  &lt;&#x2F;StoreContext.Provider&gt;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">const Component &#x3D; () &#x3D;&gt; &#123;</span><br><span class="line">  const store &#x3D; useContext(StoreContext)</span><br><span class="line">  const slice &#x3D; useStore(store, selector)</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>与原生 <code>react</code> 的 <code>Context</code>结合就能实现作用域的效果。并且进一步将<code>store</code>的创建合并到组件中，也能获得组件相关的生命周期。</p>
<h3 id="想要在不同的store中相互调用？可以"><a href="#想要在不同的store中相互调用？可以" class="headerlink" title="想要在不同的store中相互调用？可以"></a>想要在不同的store中相互调用？可以</h3><p>通过<code>useBearStore.getState()</code> 就能实现<code>store</code>间相互调用。当然需要注意管理好<code>store</code>间的依赖关系。</p>
<h3 id="想要中间件-没问题"><a href="#想要中间件-没问题" class="headerlink" title="想要中间件? 没问题"></a>想要中间件? 没问题</h3><p><code>zustand</code> 的库自带了一些中间件，其实现也非常简单。参考<code>zustand/middleware</code>的实现可以学习如何制作<code>zustand</code>的中间件。</p>
<h3 id="想要处理异步action？没问题"><a href="#想要处理异步action？没问题" class="headerlink" title="想要处理异步action？没问题"></a>想要处理异步action？没问题</h3><p>在<code>redux</code>早期，想要做异步<code>action</code>是非常头疼的事情，而<code>rtk</code>出来后会稍微好一点，但是也很麻烦。而在<code>zustand</code>，可以非常简单</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> useFishStore = create(<span class="function">(<span class="params">set</span>) =&gt;</span> (&#123;</span><br><span class="line">  fishies: &#123;&#125;,</span><br><span class="line">  fetch: <span class="keyword">async</span> (pond) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> fetch(pond)</span><br><span class="line">    set(&#123; <span class="attr">fishies</span>: <span class="keyword">await</span> response.json() &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>

<h2 id="不足与思考"><a href="#不足与思考" class="headerlink" title="不足与思考"></a>不足与思考</h2><p>再好的设计如果不加限制也会出现 <code>shit code</code>。想要把 <code>zustand</code> 这样小巧而精美的库用好而不是用坏需要一定的技术管理能力。盲目的去使用新的技术并不一定能给技术团队带来一些收益，但是可以带来新的思考。</p>
<p>另一方面，<code>zustand</code> 是一种全局<code>store</code>的设计，不能说这种设计不好，但是也意味着带来了一种比较经典的技术难题，即依赖管理。当项目中出现相互依赖的时候，如何管理，怎么确保在后续的维护中不构成污染，在调试时不会引入噪音。这是我认为所有的<code>全局store</code>都会面临的问题。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/typescript/" rel="tag">typescript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zustand/" rel="tag">zustand</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/" rel="tag">状态管理</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-谈论从把多项目合并成一个项目中获得的收益" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/2674f04a/" class="article-date">
      <time datetime="2022-10-17T07:18:34.000Z" itemprop="datePublished">2022-10-17</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/2674f04a/">谈论从把多项目合并成一个项目中获得的收益</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>在开源社区流行着这样两种项目管理的方式:</p>
<ul>
<li>多repo仓库管理 (multirepos)</li>
<li>单repo仓库但是多包管理 (monorepos)</li>
</ul>
<p>在很早的时候, 我的项目 <a target="_blank" rel="noopener" href="https://github.com/msgbyte/tailchat">tailchat</a> 是一个典型的多repo管理的项目。</p>
<p>我创建了一个组织，组织下有多个<code>tailchat</code>相关的项目:</p>
<ul>
<li>tailchat</li>
<li>tailchat-server</li>
<li>tailchat-website</li>
<li>tailchat-cli</li>
<li>tailchat-rss-bot</li>
<li>tailchat-archive</li>
<li>tailchat-docs</li>
<li>tailchat-meeting</li>
<li>…</li>
</ul>
<p>多repo的好处在于绝对的隔离，独立的发布机制，独立的仓库上下文(issues/prs)。但是我在长期的时候中逐步发现了多repo管理上的问题，以至于我抽出了时间将其合并成了一个项目。</p>
<p>接下来我会说说我遇到的问题。</p>
<h2 id="多repo遇到的问题"><a href="#多repo遇到的问题" class="headerlink" title="多repo遇到的问题"></a>多repo遇到的问题</h2><h3 id="精力上的分散"><a href="#精力上的分散" class="headerlink" title="精力上的分散"></a>精力上的分散</h3><p>多repo意味着要同时管理多个项目，一些边缘的repo甚至会长久的失去维护。对于开源项目来说失去维护意味着死亡。而开源项目也往往会意味着管理人员精力上的分散，不论是企业支持的开源项目来说还是个人支持的开源项目来说。</p>
<p>比如<code>react</code>社区知名的UI组件库 <code>antd</code>。作为一个热门库来说它一直保留着非常高的活跃度，也不缺少维护人员。但是他的基础库<code>rc-xxx</code>却很少有人去处理pr。因为摊子铺的很大，十几个小的组件库分成不同的repo，就意味着开发组的成员很难分配精力在这些改动并不频繁的仓库上面。</p>
<h3 id="发版与分发上的割裂"><a href="#发版与分发上的割裂" class="headerlink" title="发版与分发上的割裂"></a>发版与分发上的割裂</h3><p>以最基本的前后端分库来看(<code>client</code>/<code>server</code>)，两个repo意味着两套发版流程(当然可以说通过第三方平台把他们组合在一起，这个我们暂且不讨论)。同时意味着你不得不打两个tag，发两个release，以及跑两个CICD流程。如果你有一个website项目(文档)。你不适合放在任意一个<code>client</code>/<code>server</code> 仓库。这不得不造成你必须再创建第三个项目。</p>
<p>这三个项目从逻辑上来看确实是没有任何关系，但是在业务上来看却是耦合在一起的！这三者的同步就意味着需要花费维护者额外的精力，也意味着风险。</p>
<h4 id="产物困难"><a href="#产物困难" class="headerlink" title="产物困难"></a>产物困难</h4><p>另外就是项目的产物，多repo意味着多产物。多产物也意味着用户需要更多的上下文，对于不了解或者不愿意了解的用户来说这就是额外的错误可能以及精力成本。额外的入门门槛会极大的打击用户的使用信心。</p>
<p>一个简单的例子就是，作为用户更加希望只需要部署一个应用就能完成一切。而一个需要 <strong>前端+后端</strong> 的项目意味着额外的学习成本，不友好。</p>
<h3 id="基本配置不通用"><a href="#基本配置不通用" class="headerlink" title="基本配置不通用"></a>基本配置不通用</h3><p>多repo的管理机制还有一个常见的问题就是项目的配置没有办法通用。比如 <code>Tailchat</code> 项目是使用 <code>typescript</code> 来进行开发的，还需要一些自动化工具比如代码格式化，代码检查，git hooks等。那么一个项目需要配套: <code>tsconfig.json</code>, <code>commitlint</code>, <code>prettier</code>, <code>eslint</code>, <code>lintstage</code>, <code>editorconfig</code>…</p>
<p>多个项目就要配多套配置。如果改了一处需要把所有的项目都改一遍。想想就简直是一场噩梦！</p>
<p>当然可以产出一套工具专门管理相关的配置，但是这也意味着额外的精力成本，同时也引出了另一个问题，那就是改动的滞后性 —— 改动的配置没有办法立即产生效果，必须提交代码到这个工具的仓库 -&gt; 发布 -&gt; 同步到所有相关的仓库中。</p>
<p>如果说我们花了太多的时间在这种事情上，那我可以认为，这个项目的<strong>DX</strong>(Developer Experience) 是失败的。</p>
<h3 id="贡献的积极性"><a href="#贡献的积极性" class="headerlink" title="贡献的积极性"></a>贡献的积极性</h3><p>另外一个比较隐晦的问题在于，对于开源项目来说，多个包往往也会打击潜在贡献者的贡献积极性，贡献者往往期望往主库去提交代码，而多库意味着贡献的分散化。</p>
<h2 id="使用-monorepos-结构后我获得的收益"><a href="#使用-monorepos-结构后我获得的收益" class="headerlink" title="使用 monorepos 结构后我获得的收益"></a>使用 monorepos 结构后我获得的收益</h2><p>自从将原来的项目结构修改为monorepo以后，写代码都舒服了很多。其中立即能够获得的收益包括但不限于:</p>
<ul>
<li>依赖缓存复用</li>
<li>一套配置所有项目受益</li>
<li>统一管理所有 action 和 action env</li>
<li>产物统一，只需要输出一个docker镜像<ul>
<li>用户也反馈部署更加方便了</li>
</ul>
</li>
<li>统一版本号，不会再出现前端一个版本后端一个版本的情况了</li>
<li>打开项目更加方便了，不需要打开多个repo</li>
<li>只需要关注一个项目的 github webhook 就可以订阅所有动态</li>
</ul>
<p>同时，其他一些可能的操作也变得有可能了，比如：</p>
<ul>
<li>编写脚本，从客户端与服务端的代码中收集信息自动生成文档。</li>
<li>客户端根据服务端代码自动生成网络请求代码</li>
<li>…</li>
</ul>
<p>当然，有受益就有付出，<code>monorepos</code> 目前给我带来的问题有:</p>
<ul>
<li><code>pnpm install</code>的时间更长了，因为需要安装/编译的内容更多了</li>
<li><code>docker build</code>的时间更长了，因为每次打包都需要同时编译前端和后端的项目，而不管有没有发生修改。</li>
<li><code>node_modules</code>的内容过多导致在<code>tree viewer</code>中翻页会比较困难。</li>
</ul>
<p>我觉得这些问题都是可以接受的，相比收益来说这点付出几乎可以说是忽略不计。当然这只能说是个人开发者或者小团队开发能够有很大收益的方式，对于大型团队来说，<code>monorepos</code>的方式会带来很高的沟通成本和管理成本。只能说存在即合理，作为开发人员我们需要找到适合自己的当前状况的最优解。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tailchat/" rel="tag">Tailchat</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/" rel="tag">项目管理</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-webpack 打包分析 —— 通过分析工具优化体积问题" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/15675e42/" class="article-date">
      <time datetime="2022-10-03T05:42:50.000Z" itemprop="datePublished">2022-10-03</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/15675e42/">webpack 打包分析 —— 通过分析工具优化体积问题</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>众所周知现在前端代码的体积越来越大，虽然网速也上去了但是还是跟不上业务膨胀的速度。而<code>vite</code>还比较年轻，大部分的项目依旧还在使用<code>webpack</code>进行打包。</p>
<p>而另一方面<code>webpack</code>也确实在精细优化上有足够的优势。在对代码结构做深度分析与优化的时候也有非常不可替代的作用。</p>
<h2 id="开始优化"><a href="#开始优化" class="headerlink" title="开始优化"></a>开始优化</h2><p>而我的项目也非常久违的没有观察过打包内容了，因此我决定久违的看一眼。</p>
<p>在优化代码之前，我们需要找到问题。通过官方推荐的 <a target="_blank" rel="noopener" href="https://github.com/webpack-contrib/webpack-bundle-analyzer">webpack-bundle-analyzer</a> 来输出打包体积图</p>
<p>用法:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.env.ANALYSIS) &#123; <span class="comment">// 任意环境变量, 确保仅正常打包不输出分析报告</span></span><br><span class="line">  plugins.push(</span><br><span class="line">    <span class="keyword">new</span> BundleAnalyzerPlugin(&#123;</span><br><span class="line">      analyzerMode: <span class="string">&#x27;static&#x27;</span>, <span class="comment">// 将结果输出为html文件</span></span><br><span class="line">      openAnalyzer: <span class="literal">true</span>, <span class="comment">// 打包完成后打开页面</span></span><br><span class="line">    &#125;) <span class="keyword">as</span> any,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打包后自动打开网页展示如下内容:</p>
<p><img src="/images/webpack/1.png"></p>
<p>一眼就看到三个大块的包，其中 <code>all.json</code> 和 <code>twitter.json</code> 两个包都是懒加载的，可以理解，但是为什么 <code>vendors</code> 中的 <code>lodash.js</code> 这么大？我一眼看出你小子不对劲！</p>
<p><img src="/images/webpack/2.png"></p>
<p>放大看一眼，好家伙，一个包占用500多KB, 比<code>antd</code>还要高。而且 <code>lodash</code> 中并不是所有的函数都会被使用的，不应该整个包被打进来。</p>
<p>我们用 <a target="_blank" rel="noopener" href="https://github.com/moonrailgun/webpack-stats-viewer">webpack-stats-viewer-plugin</a> 来对其进行进一步分析</p>
<p>用法:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.env.ANALYSIS) &#123; <span class="comment">// 任意环境变量, 确保仅正常打包不输出分析报告</span></span><br><span class="line">  plugins.push(</span><br><span class="line">    <span class="keyword">new</span> BundleAnalyzerPlugin(&#123;</span><br><span class="line">      analyzerMode: <span class="string">&#x27;static&#x27;</span>, <span class="comment">// 将结果输出为html文件</span></span><br><span class="line">      openAnalyzer: <span class="literal">true</span>, <span class="comment">// 打包完成后打开页面</span></span><br><span class="line">    &#125;) <span class="keyword">as</span> any,</span><br><span class="line">    <span class="keyword">new</span> WebpackStatsViewerPlugin(&#123;</span><br><span class="line">      open: <span class="literal">true</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>找到异常的那个 <code>chunk</code></p>
<p><img src="/images/webpack/3.png"></p>
<p>点开右侧的 <code>modules</code> 中找到 <code>lodash</code></p>
<p><img src="/images/webpack/4.png"></p>
<p>通过 <a target="_blank" rel="noopener" href="https://github.com/moonrailgun/webpack-stats-viewer">webpack-stats-viewer-plugin</a> 的进一步分析我们可以很清晰的看到这个包是被 <code>react-fastify-form</code> 引入的。</p>
<p>我们看一下源码:</p>
<p><img src="/images/webpack/5.png"></p>
<p>果然，在代码中其他地方都是使用 <code>lodash/xxxx</code> 引入的，而在划线这行却直接把整个包引入了进来(可能是因为)，而<code>lodash</code>这个包本身不支持<code>esmodule</code>, 因此导致lodash整个包被打入，白白多占了500多KB的依赖。要知道总共也就2MB!</p>
<p>那么找到原因就好修了，直接修改源码 -&gt; 重新发布 -&gt; 更新依赖一气呵成。</p>
<h2 id="验收成果"><a href="#验收成果" class="headerlink" title="验收成果"></a>验收成果</h2><p>最后让我们看一下修复好的成果：</p>
<p><img src="/images/webpack/6.png"></p>
<p>瞬间少了一大块体积。可见能够利用好工具可以帮助我们更好的对 <code>webpack</code> 的产物进行优化。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/" rel="tag">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webpack/" rel="tag">webpack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96/" rel="tag">代码优化</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-元编程快速入门" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/8aa07df9/" class="article-date">
      <time datetime="2022-09-20T09:27:49.000Z" itemprop="datePublished">2022-09-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/8aa07df9/">元编程快速入门</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="什么是元编程-Metaprogramming"><a href="#什么是元编程-Metaprogramming" class="headerlink" title="什么是元编程(Metaprogramming)"></a>什么是元编程(Metaprogramming)</h2><p>一言以蔽之，元编程就是通过代码实现代码的一种方式。</p>
<p>在一般情况下，我们写的代码是直接对应的业务逻辑的。在一定程度上可以说是”所见即所得”的。这种代码是最符合直觉的。但是在某些情况下，正常的代码会显得不是非常高效。因此我们需要通过用代码来生成代码的方式来开发，这就是我们所说的元编程。</p>
<p>为了更好的理解元编程，我们来用一个非常简单的例子来说明一下元编程:</p>
<p>我们需要生成一些假的电话号码，用一般的代码可能会是这样实现的:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mobilePool = [<span class="string">&quot;18012345678&quot;</span>, <span class="string">&quot;18112345678&quot;</span>, <span class="string">&quot;18812345678&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRandomMobileNum</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> len = mobilePool.length;</span><br><span class="line">  <span class="keyword">return</span> mobilePool[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * len)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不论这个函数如何调用，都是从一个有限池(代码)中获取的某一项内容。但是实际上这种方式是比较受限的，因此以元编程的思想来说，我们可能会写出这样的代码:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mobilePrefix = [<span class="string">&quot;180&quot;</span>, <span class="string">&quot;181&quot;</span>, <span class="string">&quot;188&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRandomMobileNum</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> len = mobilePrefix.length;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    mobilePrefix[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * len)] +</span><br><span class="line">    <span class="built_in">Math</span>.random().toString().substr(<span class="number">2</span>, <span class="number">8</span>)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即我们设定一个规则: 一个手机号是以 <code>180,181,188</code> 开始的, 然后后面跟上 8 位任意数字的，均视为一个合法的手机号。</p>
<p>其元信息为: <code>手机号是一个以固定3位开头加8位任意数字组合而成的11位数字</code>。</p>
<p>那么我们就可以根据这种固定的规则生成无限(相对手写)种可能的手机号码。</p>
<p>当然，相信大家都能写出代码。元编程也不是什么比较新鲜的东西，大家可能都写过类似的东西。元编程的思想对于我们来说也是一种必须掌握的编程能力。</p>
<h2 id="元编程能做什么"><a href="#元编程能做什么" class="headerlink" title="元编程能做什么"></a>元编程能做什么</h2><p>当然上面的 case 过于简单，甚至可能都不能算得上元编程。元编程的概念在很多比较底层、基础的场景是非常常见的概念。</p>
<p>比较常见的场景是:</p>
<ul>
<li>编程语言(比如 typescript, coffee)</li>
<li>框架语言(比如 jsx, vue-template 等)</li>
<li>低代码/无代码平台</li>
<li>后端 CRUD 框架(比如 graphql)</li>
<li>各类 linter, formatter, parser, transformer, generator.</li>
<li>…</li>
</ul>
<p>在平时开发中，我们常用的 <code>antd</code> 的 <code>Table/Column</code> 这种形式的代码也是一种元编程方式, 而 <code>Form</code> 则是普通的编程方式</p>
<h2 id="如何实现元编程"><a href="#如何实现元编程" class="headerlink" title="如何实现元编程"></a>如何实现元编程</h2><p>我们通过来写一个元编程的表单来简单说一下元编程的实现。</p>
<p>在普通的表单中，我们的组件可能是以下这样的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function App() &#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;form&gt;</span><br><span class="line">      &lt;input name&#x3D;&quot;username&quot; required &#x2F;&gt;</span><br><span class="line">      &lt;input name&#x3D;&quot;password&quot; type&#x3D;&quot;password&quot; required &#x2F;&gt;</span><br><span class="line">      &lt;textarea name&#x3D;&quot;desc&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">      &lt;button type&#x3D;&quot;submit&quot;&gt;Submit&lt;&#x2F;button&gt;</span><br><span class="line">    &lt;&#x2F;form&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一个简单的用户注册表单, 为了多样性我还增加了一个<code>desc</code>属性用于描述用户的记录。</p>
<p>好的，那么如果用元编程的思想去看待这个问题呢？我们把 “渲染” 和 “数据” 分开考虑:</p>
<ul>
<li>这个表单有以下字段:<ul>
<li>username</li>
<li>password</li>
<li>desc</li>
</ul>
</li>
<li>一个表单可能有以下类型:<ul>
<li>input</li>
<li>password</li>
<li>textarea</li>
</ul>
</li>
</ul>
<p>然后通过组装可以变成一个数据结构:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> meta = [</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">&quot;username&quot;</span>,</span><br><span class="line">    type: <span class="string">&quot;input&quot;</span>,</span><br><span class="line">    required: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">&quot;password&quot;</span>,</span><br><span class="line">    type: <span class="string">&quot;password&quot;</span>,</span><br><span class="line">    required: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">&quot;desc&quot;</span>,</span><br><span class="line">    type: <span class="string">&quot;textarea&quot;</span>,</span><br><span class="line">    required: <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>这个就是一个元数据，用于表达想要去渲染的界面是怎么样的一个结构。</p>
<p>当然，仅仅有数据还是不够的。因此我们还需要一个通用的组件来将这个元数据转换成实际的渲染视图。</p>
<p>那么这个组件的接口应该是这样的</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;MetaForm meta=&#123;meta&#125; onSubmit=&#123;handleSubmit&#125; /&gt;</span><br></pre></td></tr></table></figure>

<p>这个组件接受一个<code>meta</code>对象用于”填充”内容，返回一个点击提交按钮的回调来告知外部</p>
<p>我们来实现一下:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MetaForm = <span class="function">(<span class="params">&#123; meta, onSubmit &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> formRef = useRef();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;form</span><br><span class="line">      ref=&#123;formRef&#125;</span><br><span class="line">      onSubmit=&#123;<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        e.preventDefault();</span><br><span class="line"></span><br><span class="line">        onSubmit(</span><br><span class="line">          meta.reduce(</span><br><span class="line">            (obj, <span class="attr">item</span>: any) =&gt; (&#123;</span><br><span class="line">              ...obj,</span><br><span class="line">              [item.name]: e.currentTarget.elements[item.name].value,</span><br><span class="line">            &#125;),</span><br><span class="line">            &#123;&#125;</span><br><span class="line">          )</span><br><span class="line">        );</span><br><span class="line">      &#125;&#125;</span><br><span class="line">    &gt;</span><br><span class="line">      &#123;meta.map(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (item.type === <span class="string">&quot;input&quot;</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&#123;item.name&#125;</span> <span class="attr">required</span>=<span class="string">&#123;item.required&#125;</span> /&gt;</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (item.type === <span class="string">&quot;password&quot;</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> (</span><br><span class="line">            &lt;input name=&#123;item.name&#125; type=<span class="string">&quot;password&quot;</span> required=&#123;item.required&#125; /&gt;</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (item.type === <span class="string">&quot;textarea&quot;</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">&#123;item.name&#125;</span> <span class="attr">required</span>=<span class="string">&#123;item.required&#125;</span> /&gt;</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Unknown Type<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">      &#125;)&#125;</span><br><span class="line"></span><br><span class="line">      &lt;button type=<span class="string">&quot;submit&quot;</span>&gt;Submit&lt;/button&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>以上就是一个非常简单的元编程的表单组件，后面想要的话还可以自定义<code>type</code>实现, 增加更多的属性, 增加校验规则等等。。而在一个完善的元编程的架构下，开发是非常迅速的。</p>
<p>作为开发，我们只要能够掌握元编程的思想，对我们对于开发的架构思想是非常有帮助的。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/meta-program/" rel="tag">meta program</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/2/">Next</a>
    </nav>
  

</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i>
                2016-2024 moonrailgun
                | <a target="_blank" href="https://beian.miit.gov.cn/">沪ICP备19001187号-1</a>
                | <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31011302006539">
                    <img src="/img/beian.png"/>
                    <span>沪公网安备 31011302006539号</span>
                  </a>
                | <a title="本网站由又拍云提供CDN加速/云存储服务" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank" rel="noopener noreferrer"><img src="/img/upyun_logo.png" height="18" style="vertical-align: bottom;" /></a>
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    
<script data-main="/js/main.js" src="https://lib.baomitu.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<!-- <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"> -->
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  </div>
</body>
</html>